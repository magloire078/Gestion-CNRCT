rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isRole(roleName) {
      return isSignedIn() && getUserData(request.auth.uid).role.name == roleName;
    }

    function isSuperAdmin() {
      return isRole('Super Administrateur');
    }

    function isAdmin() {
      return isRole('Administrateur') || isSuperAdmin();
    }
    
    function isHRManager() {
        return isRole('Manager RH') || isAdmin();
    }

    function isEmployee() {
        return isRole('Employ√©') || isHRManager();
    }
    
    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    // --- Rules ---

    // Settings: Publicly readable for app configuration
    match /settings/{settingId} {
        allow read: if true;
        allow write: if isAdmin();
    }

    // Users: Can read/update their own profile. Admins can manage all.
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if true; // Allows signup
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // Roles: Readable by all authenticated users, managed by Admins.
    match /roles/{roleId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    // Departments, Directions, Services: Managed by Admins
    match /departments/{docId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }
    match /directions/{docId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }
    match /services/{docId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }

    // Employees: HR and Admins can manage. All employees can list.
    match /employees/{employeeId} {
      allow list: if isSignedIn();
      allow get: if isEmployee();
      allow create, update, delete: if isHRManager();
      
      // History subcollection
      match /history/{eventId} {
        allow read, create, update, delete: if isHRManager();
      }
    }
    
    // Chiefs: HR and Admins can manage.
    match /chiefs/{chiefId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isHRManager();
    }
    
    // Missions, Fleet, Supplies, Conflicts: HR and Admins can manage.
    match /missions/{missionId} {
        allow read, create, update, delete: if isHRManager();
    }
    match /fleet/{vehicleId} {
        allow read, create, update, delete: if isHRManager();
    }
    match /supplies/{supplyId} {
        allow read, create, update, delete: if isHRManager();
    }
    match /conflicts/{conflictId} {
        allow read, create, update, delete: if isHRManager();
    }

    // Assets: HR and Admins can manage.
    match /assets/{assetId} {
        allow read, create, update, delete: if isHRManager();
    }
    
    // Leaves: Employees can read/create their own. HR/Admins manage all.
    match /leaves/{leaveId} {
      allow read, update: if isHRManager() || (isSignedIn() && resource.data.employee == getUserData(request.auth.uid).name);
      allow create: if isEmployee();
      allow delete: if isHRManager();
    }

    // Evaluations: Involved parties can read. Managers can create/update.
    match /evaluations/{evalId} {
        allow read: if isHRManager() || (isSignedIn() && (request.auth.uid == resource.data.employeeId || request.auth.uid == resource.data.managerId));
        allow create, update, delete: if isHRManager();
    }
    
    // Notifications: Read by owner, created by the system (server-side).
    match /notifications/{notifId} {
        allow read, update: if isOwner(resource.data.userId);
        allow create: if isSignedIn(); // Allow server-side functions to create
        allow delete: if isOwner(resource.data.userId);
    }
    
    // Counters for mission numbers
    match /counters/{counterId} {
        allow read, write: if isSignedIn(); // Allow server-side functions
    }

    // Repository for documents
    match /repository/{docId} {
        allow read, create, delete: if isEmployee();
    }

    // Budget Lines
    match /budgetLines/{lineId} {
        allow read, create, update, delete: if isHRManager();
    }
  }
}
